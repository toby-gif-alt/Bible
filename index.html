<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bible Study (Weekly Deep-Dive)</title>
  <!-- Tailwind via CDN for a clean, mobile‚Äëfirst UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" href="/assets/icon-192.svg" type="image/svg+xml" />
  <style>
    /* Utility tweaks for mobile */
    .safe { padding-bottom: env(safe-area-inset-bottom); }
    .scroll-snap-x { scroll-snap-type: x mandatory; }
    .snap-center { scroll-snap-align: center; }
    .thin { scrollbar-width: thin; }
    /* Hide number input spinners on mobile */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="bg-slate-100 text-slate-900">
  <!-- Top bar -->
  <header class="sticky top-0 z-30 bg-slate-900 text-white shadow">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <button id="menuBtn" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 active:scale-[0.98]" aria-label="Open menu">‚ò∞</button>
      <h1 class="font-semibold">Bible Study</h1>
      <button id="todayBtn" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 active:scale-[0.98]">Today</button>
    </div>
  </header>

  <!-- Drawer / Menu -->
  <aside id="drawer" class="fixed inset-0 z-40 hidden">
    <div class="absolute inset-0 bg-black/40" id="drawerBackdrop"></div>
    <div class="absolute left-0 top-0 h-full w-[90%] max-w-sm bg-white shadow-xl p-4 overflow-y-auto thin">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Menu</h2>
        <button id="drawerClose" class="p-2 rounded hover:bg-slate-100" aria-label="Close">‚úï</button>
      </div>

      <div class="mt-4 space-y-6">
        <section>
          <h3 class="font-semibold text-slate-700">Bible Translation</h3>
          <p class="text-sm text-slate-500 mb-2">Choose your primary reading translation. (KJV and WEB are included; more can be added.)</p>
          <select id="primaryVersion" class="w-full border rounded-lg p-2">
            <option value="KJV">KJV (Public Domain)</option>
            <option value="WEB">WEB ‚Äî World English Bible (PD)</option>
          </select>
          <label class="block mt-3 text-sm text-slate-600">
            Secondary (for compare):
            <select id="secondaryVersion" class="w-full border rounded-lg p-2 mt-1">
              <option value="none">None</option>
              <option value="WEB">WEB</option>
              <option value="KJV">KJV</option>
            </select>
          </label>
        </section>

        <section>
          <h3 class="font-semibold text-slate-700">Study Rhythm</h3>
          <p class="text-sm text-slate-500">A weekly focus on a single verse or short passage, with a different pedagogical lens each day.</p>
          <ul class="text-sm list-disc ml-5 text-slate-600">
            <li>Mon ‚Äî Context & big picture</li>
            <li>Tue ‚Äî Translation compare & wording</li>
            <li>Wed ‚Äî Word study & key terms</li>
            <li>Thu ‚Äî Theologians & traditions</li>
            <li>Fri ‚Äî Cross‚Äëreferences</li>
            <li>Sat ‚Äî Meditation & prayer</li>
            <li>Sun ‚Äî Application & memorisation</li>
          </ul>
        </section>

        <section>
          <h3 class="font-semibold text-slate-700">Group / Family Mode</h3>
          <p class="text-sm text-slate-500 mb-2">Enable discussion questions for different age groups (Child, Teen, Adult).</p>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="groupModeToggle" class="w-4 h-4 rounded">
            <span class="text-sm">Enable Group / Family Mode</span>
          </label>
        </section>

        <section>
          <h3 class="font-semibold text-slate-700">About & Approach</h3>
          <p class="text-sm text-slate-600">Learn about the purpose, methodology, and privacy of this app.</p>
          <button id="aboutBtn" class="mt-2 px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-500 text-sm">
            About & Approach
          </button>
        </section>

        <section>
          <h3 class="font-semibold text-slate-700">Statement</h3>
          <p class="text-sm text-slate-600">This app aims to help Christians know the Scriptures deeply and devotionally. It presents multiple perspectives from the historic church while encouraging prayerful discernment.</p>
          <blockquote class="mt-2 border-l-4 border-indigo-400 pl-3 italic text-sm text-slate-700" id="randomBlessing">
            "Your word is a lamp unto my feet, and a light unto my path." ‚Äî Psalm 119:105
          </blockquote>
        </section>

        <section>
          <h3 class="font-semibold text-slate-700">Data & Privacy</h3>
          <p class="text-sm text-slate-600">All notes are stored on your device using localStorage. You can export/import below.</p>
          <div class="mt-2 flex gap-2">
            <button id="exportBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Export Data</button>
            <label class="px-3 py-2 rounded-lg bg-slate-200 cursor-pointer">Import Data<input id="importInput" type="file" accept="application/json" class="hidden"/></label>
          </div>
        </section>

      </div>
    </div>
  </aside>

  <!-- Main pages -->
  <main class="max-w-3xl mx-auto p-4 space-y-4">
    <!-- Home -->
    <section id="home" class="">
      <div class="flex flex-col gap-4">
        <div class="rounded-2xl bg-gradient-to-br from-indigo-600 to-sky-500 text-white p-5 shadow">
          <h2 class="text-xl font-semibold">This Week</h2>
          <p class="opacity-90" id="thisWeekRef">Loading‚Ä¶</p>
          <p class="mt-2 text-sm opacity-90" id="thisWeekSummary">Plan: different focus each day to saturate in the passage.</p>
          <div class="mt-3 flex gap-2">
            <button class="px-3 py-2 rounded-lg bg-white/20 hover:bg-white/30" onclick="nav('study')">Open Study</button>
            <button class="px-3 py-2 rounded-lg bg-white/20 hover:bg-white/30" onclick="nav('bible')">Open Bible</button>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button class="rounded-2xl p-4 bg-white shadow active:scale-[0.99]" onclick="nav('study')">
            <div class="text-2xl">üìñ</div>
            <div class="font-semibold">This Week‚Äôs Study</div>
            <div class="text-sm text-slate-600">Daily prompts, notes, compare translations.</div>
          </button>
          <button class="rounded-2xl p-4 bg-white shadow active:scale-[0.99]" onclick="nav('bible')">
            <div class="text-2xl">üìö</div>
            <div class="font-semibold">Bible</div>
            <div class="text-sm text-slate-600">Navigate by Testament ‚Üí Book ‚Üí Chapter.</div>
          </button>
        </div>
      </div>
    </section>

    <!-- Study -->
    <section id="study" class="hidden">
      <div class="rounded-2xl bg-white shadow p-4">
        <div class="flex items-center justify-between gap-2">
          <div>
            <h2 class="font-semibold">Weekly Study</h2>
            <p class="text-sm text-slate-600" id="studyRef"></p>
          </div>
          <button class="text-sm px-3 py-2 rounded-lg bg-indigo-600 text-white" id="openInBibleBtn">Open in Bible</button>
        </div>

        <!-- Day lenses -->
        <div class="mt-3 flex overflow-x-auto gap-2 scroll-snap-x thin">
          <button data-day="1" class="lensBtn snap-center px-3 py-2 rounded-full bg-slate-200">Mon</button>
          <button data-day="2" class="lensBtn snap-center px-3 py-2 rounded-full bg-slate-200">Tue</button>
          <button data-day="3" class="lensBtn snap-center px-3 py-2 rounded-full bg-slate-200">Wed</button>
          <button data-day="4" class="lensBtn snap-center px-3 py-2 rounded-full bg-slate-200">Thu</button>
          <button data-day="5" class="lensBtn snap-center px-3 py-2 rounded-full bg-slate-200">Fri</button>
          <button data-day="6" class="lensBtn snap-center px-3 py-2 rounded-full bg-slate-200">Sat</button>
          <button data-day="7" class="lensBtn snap-center px-3 py-2 rounded-full bg-slate-200">Sun</button>
        </div>

        <div class="mt-4 space-y-4">
          <div class="p-3 bg-slate-50 rounded-xl" id="studyPassageBox">
            <div class="text-sm text-slate-600" id="studyPassageHeading"></div>
            <div id="studyPassageText" class="mt-2 leading-relaxed"></div>
            <div id="compareBox" class="mt-2 border-t pt-2 hidden">
              <div class="text-sm font-semibold">Compare</div>
              <div id="compareText" class="text-sm mt-1"></div>
            </div>
          </div>

          <!-- Full Chapter Context -->
          <div class="border rounded-xl overflow-hidden">
            <button id="contextToggle" class="w-full px-4 py-3 bg-slate-100 hover:bg-slate-200 flex items-center justify-between">
              <span class="font-semibold">Context (Full Chapter)</span>
              <span id="contextChevron">‚ñº</span>
            </button>
            <div id="contextContent" class="p-4 bg-white hidden">
              <div id="contextPrimaryText" class="leading-relaxed"></div>
              <div id="contextCompareBox" class="mt-3 border-t pt-3 hidden">
                <div class="text-sm font-semibold mb-2">Compare</div>
                <div id="contextCompareText" class="text-sm leading-relaxed"></div>
              </div>
            </div>
          </div>

          <!-- Memorisation Mode Panel -->
          <div class="border rounded-xl overflow-hidden">
            <button id="memorisationToggle" class="w-full px-4 py-3 bg-slate-100 hover:bg-slate-200 flex items-center justify-between">
              <span class="font-semibold">Memorisation Mode</span>
              <span id="memorisationChevron">‚ñº</span>
            </button>
            <div id="memorisationContent" class="p-4 bg-white hidden">
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-semibold mb-2">Mode</label>
                  <div class="flex gap-2">
                    <button id="modeHide" class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm">Hide words</button>
                    <button id="modeFirstLetters" class="px-3 py-2 rounded-lg bg-slate-200 text-sm">First letters</button>
                  </div>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold mb-2">
                    Difficulty: <span id="difficultyLabel">40%</span>
                  </label>
                  <input type="range" id="difficultySlider" min="10" max="90" value="40" class="w-full">
                </div>

                <div>
                  <label class="block text-sm font-semibold mb-2">Timer</label>
                  <div class="flex gap-2">
                    <button class="timerBtn px-3 py-2 rounded-lg bg-slate-200 text-sm" data-seconds="30">30s</button>
                    <button class="timerBtn px-3 py-2 rounded-lg bg-slate-200 text-sm" data-seconds="60">60s</button>
                    <button class="timerBtn px-3 py-2 rounded-lg bg-slate-200 text-sm" data-seconds="90">90s</button>
                    <button id="timerStop" class="px-3 py-2 rounded-lg bg-red-600 text-white text-sm hidden">Stop</button>
                  </div>
                  <div id="timerDisplay" class="mt-2 text-2xl font-bold text-center hidden"></div>
                </div>

                <div id="memoryStats" class="mt-3 p-3 bg-slate-50 rounded-lg text-sm hidden">
                  <div class="font-semibold">Your Best</div>
                  <div id="memoryStatsContent"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="p-3 bg-slate-50 rounded-xl" id="lensContent">
            <!-- dynamic prompts / content per day -->
          </div>

          <!-- Group Questions Box -->
          <div id="groupQuestionsBox" class="hidden p-4 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl border border-purple-200">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold text-lg text-purple-900">Group Questions</h3>
              <button id="copyForTonightBtn" class="px-3 py-2 rounded-lg bg-purple-600 text-white text-sm hover:bg-purple-500 active:scale-[0.98]">
                Copy for tonight
              </button>
            </div>
            <div class="space-y-4">
              <div class="p-3 bg-white rounded-lg border border-blue-200">
                <h4 class="font-semibold text-blue-900 mb-2">üë∂ Child</h4>
                <ul id="childQuestions" class="list-disc ml-5 text-sm text-slate-700"></ul>
              </div>
              <div class="p-3 bg-white rounded-lg border border-green-200">
                <h4 class="font-semibold text-green-900 mb-2">üßë Teen</h4>
                <ul id="teenQuestions" class="list-disc ml-5 text-sm text-slate-700"></ul>
              </div>
              <div class="p-3 bg-white rounded-lg border border-purple-200">
                <h4 class="font-semibold text-purple-900 mb-2">üë® Adult</h4>
                <ul id="adultQuestions" class="list-disc ml-5 text-sm text-slate-700"></ul>
              </div>
            </div>
          </div>

          <!-- Theologians & Traditions Panel -->
          <div class="border rounded-xl overflow-hidden">
            <button id="theologiansToggle" class="w-full px-4 py-3 bg-slate-100 hover:bg-slate-200 flex items-center justify-between">
              <span class="font-semibold">Theologians &amp; Traditions</span>
              <span id="theologiansChevron">‚ñº</span>
            </button>
            <div id="theologiansContent" class="p-4 bg-white hidden">
              <div id="theologiansCards"></div>
              <div class="mt-4 border-t pt-4">
                <button id="compareVoicesToggle" class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">
                  Compare voices
                </button>
                <div id="compareVoicesContent" class="mt-3 hidden p-3 bg-slate-50 rounded-lg text-sm"></div>
              </div>
            </div>
          </div>

          <!-- Cross-References Panel -->
          <div class="border rounded-xl overflow-hidden">
            <button id="xrefsToggle" class="w-full px-4 py-3 bg-slate-100 hover:bg-slate-200 flex items-center justify-between">
              <span class="font-semibold">Cross-References</span>
              <span id="xrefsChevron">‚ñº</span>
            </button>
            <div id="xrefsContent" class="p-4 bg-white hidden">
              <div id="xrefsList"></div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold">Your notes</label>
            <textarea id="studyNotes" class="w-full mt-1 border rounded-lg p-3 h-36" placeholder="Write prayers, observations, connections‚Ä¶"></textarea>
            <div class="mt-2 text-right">
              <button id="saveNotesBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Save Notes</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Bible Navigator -->
    <section id="bible" class="hidden">
      <div class="rounded-2xl bg-white shadow p-4">
        <h2 class="font-semibold">Bible</h2>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <button class="px-3 py-2 rounded-lg bg-slate-200" onclick="showBooks('OT')">Old Testament</button>
          <button class="px-3 py-2 rounded-lg bg-slate-200" onclick="showBooks('NT')">New Testament</button>
        </div>

        <div id="books" class="mt-3 grid grid-cols-2 gap-2"></div>
        <div id="chapters" class="mt-3 grid grid-cols-6 gap-2"></div>
        <div id="verses" class="mt-3 space-y-3"></div>
      </div>
    </section>

    <!-- About & Approach -->
    <section id="about" class="hidden">
      <div class="rounded-2xl bg-white shadow p-4">
        <h2 class="text-xl font-semibold mb-4">About & Approach</h2>
        
        <div class="space-y-4">
          <section>
            <h3 class="font-semibold text-lg text-slate-800 mb-2">Purpose</h3>
            <p class="text-slate-700">This app aims to help Christians know Scripture deeply and devotionally. We provide tools and resources for weekly deep-dive study, combining structured daily lenses with historical theological insights.</p>
          </section>

          <section>
            <h3 class="font-semibold text-lg text-slate-800 mb-2">Approach</h3>
            <ul class="list-disc ml-5 text-slate-700 space-y-1">
              <li><strong>Scripture interprets Scripture:</strong> We emphasize cross-references and biblical theology, letting the Bible illuminate itself.</li>
              <li><strong>Reading across Christian traditions:</strong> We present perspectives from Catholic, Orthodox, Protestant, and other traditions to enrich understanding.</li>
              <li><strong>Prayerful discernment:</strong> Study is paired with meditation, prayer, and application for spiritual formation.</li>
              <li><strong>Humility about translations:</strong> We encourage comparing translations and understanding the original languages where possible, recognizing each translation's strengths.</li>
            </ul>
          </section>

          <section>
            <h3 class="font-semibold text-lg text-slate-800 mb-2">Sources</h3>
            <p class="text-slate-700 mb-2">We are careful to honor the work of scholars and theologians:</p>
            <ul class="list-disc ml-5 text-slate-700 space-y-1">
              <li><strong>Public-domain excerpts</strong> (e.g., Augustine, Athanasius, Aquinas, Luther, Calvin, Wesley) are quoted directly with citations.</li>
              <li><strong>Modern authors</strong> are summarized (not quoted) with proper citations, respecting copyright while sharing their insights.</li>
            </ul>
          </section>

          <section>
            <h3 class="font-semibold text-lg text-slate-800 mb-2">Privacy</h3>
            <p class="text-slate-700 mb-2">Your data belongs to you:</p>
            <ul class="list-disc ml-5 text-slate-700 space-y-1">
              <li><strong>Local storage only:</strong> All notes and memory stats are stored only on your device using localStorage.</li>
              <li><strong>No cloud sync:</strong> We don't collect, transmit, or store your data on any server.</li>
              <li><strong>Export/import:</strong> You can manually export your notes as JSON and import them on another device or for backup purposes.</li>
            </ul>
          </section>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer nav -->
  <footer class="fixed bottom-0 inset-x-0 bg-white border-t safe">
    <div class="max-w-3xl mx-auto px-4 py-2 grid grid-cols-4 gap-2">
      <button class="p-2 rounded-lg hover:bg-slate-100" onclick="nav('home')">Home</button>
      <button class="p-2 rounded-lg hover:bg-slate-100" onclick="nav('study')">Study</button>
      <button class="p-2 rounded-lg hover:bg-slate-100" onclick="nav('bible')">Bible</button>
      <button class="p-2 rounded-lg hover:bg-slate-100" onclick="nav('about')">About</button>
    </div>
  </footer>

  <script>
    /*********************
     * Minimal Bible Data *
     * ------------------ *
     * To keep this single-file demo small, only a few chapters are embedded
     * (John 1 & 3 KJV/WEB, Psalm 23 KJV/WEB). The app is designed to load
     * full Bible JSON files if you add them to your repo later.
     *
     * HOW TO ADD FULL BIBLES (optional):
     * 1) Create /bibles/KJV/ and /bibles/WEB/ folders in your repo.
     * 2) Put JSON files named like "John.json", "Matthew.json", etc., where each file maps chapter‚Üíverse arrays.
     *    Example schema:
     *    {
     *      "1": ["In the beginning ...", "He was ..."],
     *      "2": ["On the third day ..."]
     *    }
     * 3) This index will try to fetch them on demand. If not found, it falls back to the embedded samples.
     */

    const BOOKS = {
      OT: [
        "Genesis","Exodus","Leviticus","Numbers","Deuteronomy","Joshua","Judges","Ruth","1 Samuel","2 Samuel","1 Kings","2 Kings","1 Chronicles","2 Chronicles","Ezra","Nehemiah","Esther","Job","Psalms","Proverbs","Ecclesiastes","Song of Solomon","Isaiah","Jeremiah","Lamentations","Ezekiel","Daniel","Hosea","Joel","Amos","Obadiah","Jonah","Micah","Nahum","Habakkuk","Zephaniah","Haggai","Zechariah","Malachi"
      ],
      NT: [
        "Matthew","Mark","Luke","John","Acts","Romans","1 Corinthians","2 Corinthians","Galatians","Ephesians","Philippians","Colossians","1 Thessalonians","2 Thessalonians","1 Timothy","2 Timothy","Titus","Philemon","Hebrews","James","1 Peter","2 Peter","1 John","2 John","3 John","Jude","Revelation"
      ]
    };

    // Embedded sample passages (KJV + WEB)
    const SAMPLE = {
      KJV: {
        Psalms: {"23": [
          "The LORD is my shepherd; I shall not want.",
          "He maketh me to lie down in green pastures: he leadeth me beside the still waters.",
          "He restoreth my soul: he leadeth me in the paths of righteousness for his name's sake.",
          "Yea, though I walk through the valley of the shadow of death, I will fear no evil: for thou art with me; thy rod and thy staff they comfort me.",
          "Thou preparest a table before me in the presence of mine enemies: thou anointest my head with oil; my cup runneth over.",
          "Surely goodness and mercy shall follow me all the days of my life: and I will dwell in the house of the LORD for ever."
        ]},
        John: {"1": [
          "In the beginning was the Word, and the Word was with God, and the Word was God.",
          "The same was in the beginning with God.",
          "All things were made by him; and without him was not any thing made that was made.",
          "In him was life; and the life was the light of men.",
          "And the light shineth in darkness; and the darkness comprehended it not."
        ],
        "3": [
          "There was a man of the Pharisees, named Nicodemus, a ruler of the Jews:",
          "The same came to Jesus by night, and said unto him, Rabbi, we know that thou art a teacher come from God: for no man can do these miracles that thou doest, except God be with him.",
          "Jesus answered and said unto him, Verily, verily, I say unto thee, Except a man be born again, he cannot see the kingdom of God.",
          "Nicodemus saith unto him, How can a man be born when he is old? can he enter the second time into his mother's womb, and be born?",
          "Jesus answered, Verily, verily, I say unto thee, Except a man be born of water and of the Spirit, he cannot enter into the kingdom of God.",
          "That which is born of the flesh is flesh; and that which is born of the Spirit is spirit.",
          "Marvel not that I said unto thee, Ye must be born again.",
          "The wind bloweth where it listeth, and thou hearest the sound thereof, but canst not tell whence it cometh, and whither it goeth: so is every one that is born of the Spirit.",
          "Nicodemus answered and said unto him, How can these things be?",
          "Jesus answered and said unto him, Art thou a master of Israel, and knowest not these things?",
          "Verily, verily, I say unto thee, We speak that we do know, and testify that we have seen; and ye receive not our witness.",
          "If I have told you earthly things, and ye believe not, how shall ye believe, if I tell you of heavenly things?",
          "And no man hath ascended up to heaven, but he that came down from heaven, even the Son of man which is in heaven.",
          "And as Moses lifted up the serpent in the wilderness, even so must the Son of man be lifted up:",
          "That whosoever believeth in him should not perish, but have eternal life.",
          "For God so loved the world, that he gave his only begotten Son, that whosoever believeth in him should not perish, but have everlasting life."
        ]}},
      WEB: {
        Psalms: {"23": [
          "Yahweh is my shepherd: I shall lack nothing.",
          "He makes me lie down in green pastures. He leads me beside still waters.",
          "He restores my soul. He guides me in the paths of righteousness for his name‚Äôs sake.",
          "Even though I walk through the valley of the shadow of death, I will fear no evil, for you are with me. Your rod and your staff, they comfort me.",
          "You prepare a table before me in the presence of my enemies. You anoint my head with oil. My cup runs over.",
          "Surely goodness and loving kindness shall follow me all the days of my life, and I will dwell in Yahweh‚Äôs house forever."
        ]},
        John: {"1": [
          "In the beginning was the Word, and the Word was with God, and the Word was God.",
          "The same was in the beginning with God.",
          "All things were made through him. Without him, nothing was made that has been made.",
          "In him was life, and the life was the light of men.",
          "The light shines in the darkness, and the darkness hasn‚Äôt overcome it."
        ],
        "3": [
          "Now there was a man of the Pharisees named Nicodemus, a ruler of the Jews.",
          "The same came to him by night, and said to him, ‚ÄúRabbi, we know that you are a teacher come from God, for no one can do these signs that you do, unless God is with him.‚Äù",
          "Jesus answered him, ‚ÄúMost certainly, I tell you, unless one is born anew, he can‚Äôt see God‚Äôs Kingdom.‚Äù",
          "Nicodemus said to him, ‚ÄúHow can a man be born when he is old? Can he enter a second time into his mother‚Äôs womb, and be born?‚Äù",
          "Jesus answered, ‚ÄúMost certainly I tell you, unless one is born of water and spirit, he can‚Äôt enter into God‚Äôs Kingdom.",
          "That which is born of the flesh is flesh. That which is born of the Spirit is spirit.",
          "Don‚Äôt marvel that I said to you, ‚ÄòYou must be born anew.‚Äô",
          "The wind blows where it wants to, and you hear its sound, but don‚Äôt know where it comes from and where it is going. So is everyone who is born of the Spirit.‚Äù",
          "Nicodemus answered him, ‚ÄúHow can these things be?‚Äù",
          "Jesus answered him, ‚ÄúAre you the teacher of Israel, and don‚Äôt understand these things?",
          "Most certainly I tell you, we speak that which we know, and testify of that which we have seen, and you don‚Äôt receive our witness.",
          "If I told you earthly things and you don‚Äôt believe, how will you believe if I tell you heavenly things?",
          "No one has ascended into heaven but he who descended out of heaven, the Son of Man, who is in heaven.",
          "As Moses lifted up the serpent in the wilderness, even so must the Son of Man be lifted up,",
          "that whoever believes in him should not perish, but have eternal life.",
          "For God so loved the world that he gave his one and only Son, that whoever believes in him should not perish, but have eternal life."
        ]}}
    };

// Chapter counts for all 66 books (KJV/WEB canonical order)
    const CHAPTER_COUNTS = {
      // Old Testament
      "Genesis": 50, "Exodus": 40, "Leviticus": 27, "Numbers": 36, "Deuteronomy": 34,
      "Joshua": 24, "Judges": 21, "Ruth": 4, "1 Samuel": 31, "2 Samuel": 24,
      "1 Kings": 22, "2 Kings": 25, "1 Chronicles": 29, "2 Chronicles": 36,
      "Ezra": 10, "Nehemiah": 13, "Esther": 10, "Job": 42, "Psalms": 150,
      "Proverbs": 31, "Ecclesiastes": 12, "Song of Solomon": 8,
      "Isaiah": 66, "Jeremiah": 52, "Lamentations": 5, "Ezekiel": 48, "Daniel": 12,
      "Hosea": 14, "Joel": 3, "Amos": 9, "Obadiah": 1, "Jonah": 4,
      "Micah": 7, "Nahum": 3, "Habakkuk": 3, "Zephaniah": 3, "Haggai": 2,
      "Zechariah": 14, "Malachi": 4,
      // New Testament
      "Matthew": 28, "Mark": 16, "Luke": 24, "John": 21, "Acts": 28,
      "Romans": 16, "1 Corinthians": 16, "2 Corinthians": 13, "Galatians": 6,
      "Ephesians": 6, "Philippians": 4, "Colossians": 4,
      "1 Thessalonians": 5, "2 Thessalonians": 3, "1 Timothy": 6, "2 Timothy": 4,
      "Titus": 3, "Philemon": 1, "Hebrews": 13, "James": 5,
      "1 Peter": 5, "2 Peter": 3, "1 John": 5, "2 John": 1, "3 John": 1,
      "Jude": 1, "Revelation": 22
    };

    // Weekly "big verses" ‚Äî curated list of 60+ foundational verses (NT first)
    const BIG_VERSES = [
      // Core NT Gospel verses
      "John 1:1",
      "John 3:16",
      "John 14:6",
      "Matthew 28:18-20",
      "Romans 3:23",
      "Romans 5:8",
      "Romans 6:23",
      "Romans 8:1",
      "Romans 8:28",
      "Romans 10:9",
      "Romans 12:1-2",
      "1 Corinthians 13:4-7",
      "1 Corinthians 15:3-4",
      "2 Corinthians 5:17",
      "Galatians 2:20",
      "Galatians 5:22-23",
      "Ephesians 2:8-10",
      "Philippians 2:5-11",
      "Philippians 4:6-7",
      "Philippians 4:13",
      "Colossians 3:1-2",
      "1 Thessalonians 5:16-18",
      "2 Timothy 3:16-17",
      "Hebrews 4:12",
      "Hebrews 11:1",
      "Hebrews 13:8",
      "James 1:2-5",
      "James 2:17",
      "1 Peter 1:3-5",
      "1 Peter 2:9",
      "1 Peter 3:15",
      "1 Peter 5:7",
      "1 John 1:8-9",
      "1 John 4:7-8",
      "Revelation 21:1-5",
      // Key OT verses
      "Genesis 1:1",
      "Genesis 1:27",
      "Exodus 20:3",
      "Deuteronomy 6:4-5",
      "Joshua 1:8-9",
      "1 Samuel 16:7",
      "Psalm 1:1-3",
      "Psalm 23:1-6",
      "Psalm 46:1",
      "Psalm 51:10",
      "Psalm 91:1-2",
      "Psalm 103:12",
      "Psalm 119:105",
      "Psalm 139:14",
      "Proverbs 3:5-6",
      "Proverbs 16:3",
      "Proverbs 22:6",
      "Ecclesiastes 3:1",
      "Isaiah 40:31",
      "Isaiah 41:10",
      "Isaiah 53:4-6",
      "Isaiah 55:8-9",
      "Jeremiah 29:11",
      "Jeremiah 31:3",
      "Micah 6:8"
    ];

    // Local storage helpers
    const LS = {
      get(k, d=null){ try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d }},
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)) }
    };

    // State - initialize with today's date if startDate is missing
    let state = LS.get('state', {});
    if (!state.startDate) {
      const today = new Date();
      state.startDate = today.toISOString().split('T')[0]; // YYYY-MM-DD format
    }
    state.primary = state.primary || 'WEB';
    state.secondary = state.secondary || 'none';
    state.groupMode = state.groupMode || false;
    LS.set('state', state);

    // Generate COVERAGE queue (one verse per chapter for complete Bible)
    let COVERAGE = [];
    function generateCoverage() {
      const coverage = [];
      const allBooks = [...BOOKS.NT, ...BOOKS.OT]; // NT first, then OT
      
      for (const book of allBooks) {
        const chapterCount = CHAPTER_COUNTS[book];
        if (!chapterCount) continue;
        
        for (let chapter = 1; chapter <= chapterCount; chapter++) {
          // Default to verse 1; will compute middle verse on demand
          coverage.push(`${book} ${chapter}:1`);
        }
      }
      return coverage;
    }
    COVERAGE = generateCoverage();

    // Build complete PLAN: BIG_VERSES followed by COVERAGE (excluding duplicates)
    let PLAN = [];
    function buildPlan() {
      const plan = [...BIG_VERSES];
      const seen = new Set(BIG_VERSES.map(ref => normalizeRef(ref)));
      
      for (const ref of COVERAGE) {
        const normalized = normalizeRef(ref);
        if (!seen.has(normalized)) {
          plan.push(ref);
          seen.add(normalized);
        }
      }
      return plan;
    }
    
    // Normalize ref for comparison (handle ranges vs single verses)
    function normalizeRef(ref) {
      const parsed = parseRef(ref);
      if (!parsed) return ref;
      // For comparison, use book:chapter format to detect duplicates
      return `${parsed.book} ${parsed.chapter}`;
    }
    
    PLAN = buildPlan();

    // Basic navigation
    function nav(id){
      for(const sec of document.querySelectorAll('main > section')) sec.classList.add('hidden');
      document.getElementById(id).classList.remove('hidden');
      if(id==='study') renderStudy();
    }

    // Drawer
    const drawer = {
      open(){ document.getElementById('drawer').classList.remove('hidden') },
      close(){ document.getElementById('drawer').classList.add('hidden') }
    };
    document.getElementById('menuBtn').onclick = drawer.open;
    document.getElementById('drawerBackdrop').onclick = drawer.close;
    document.getElementById('drawerClose').onclick = drawer.close;
    document.getElementById('aboutBtn').onclick = () => { drawer.close(); nav('about'); };

    // Version selectors
    const primaryVersion = document.getElementById('primaryVersion');
    const secondaryVersion = document.getElementById('secondaryVersion');
    const groupModeToggle = document.getElementById('groupModeToggle');
    primaryVersion.value = state.primary;
    secondaryVersion.value = state.secondary;
    groupModeToggle.checked = state.groupMode;
    primaryVersion.onchange = () => { state.primary = primaryVersion.value; LS.set('state', state); renderStudy(); };
    secondaryVersion.onchange = () => { state.secondary = secondaryVersion.value; LS.set('state', state); renderStudy(); };
    groupModeToggle.onchange = () => { state.groupMode = groupModeToggle.checked; LS.set('state', state); renderStudy(); };

    // Weekly selection (based on weeks since startDate)
    function weekIndex(){
      const start = new Date(state.startDate + 'T00:00:00');
      const now = new Date();
      const diff = Math.floor((now - start) / (1000*60*60*24*7));
      return Math.max(0, diff); // Never negative
    }

    function thisWeekRef(){ return PLAN[weekIndex() % PLAN.length] }

    // Render home card
    function renderHome(){
      document.getElementById('thisWeekRef').innerText = thisWeekRef();
    }

    // Parse ref like "John 3:16" or "Matthew 5:3-10"
    function parseRef(ref){
      const m = ref.match(/^(.*?)\s+(\d+)(?::(\d+)(?:-(\d+))?)?$/);
      if(!m) return null;
      return { book: m[1], chapter: m[2], v1: m[3] ? +m[3] : 1, v2: m[4] ? +m[4] : (m[3]?+m[3]:null) };
    }

    // Load passage and return verses
    async function loadPassage(version, book, chapter) {
      const path = `bibles/${version}/${book}.json`;
      try {
        const r = await fetch(path);
        if(r.ok){
          const data = await r.json();
          const verses = data[String(chapter)] || [];
          if(!verses.length) throw new Error('No chapter');
          return verses;
        }
      } catch {}
      // Fallback to sample
      const src = SAMPLE[version]?.[book]?.[String(chapter)] || [];
      return src;
    }

    // Get verse count for a chapter (with caching)
    async function getVerseCount(version, book, chapter) {
      const cacheKey = `versesCount:${book}:${chapter}`;
      const cached = LS.get(cacheKey, null);
      if (cached !== null) return cached;
      
      const verses = await loadPassage(version, book, chapter);
      const count = verses.length;
      LS.set(cacheKey, count);
      return count;
    }

    // Compute middle verse for a chapter
    async function getMiddleVerse(version, book, chapter) {
      const count = await getVerseCount(version, book, chapter);
      if (count === 0) return 1;
      return Math.max(1, Math.round(count / 2));
    }

    // Load verses (tries fetch from /bibles/{ver}/{Book}.json, else sample)
    async function getPassage(version, book, chapter, v1, v2){
      const verses = await loadPassage(version, book, chapter);
      if(verses.length === 0) {
        return [{n:0, t:`[${version}] ${book} ${chapter}:${v1||1}${v2?'-'+v2:''} not available in demo. Add /bibles/${version}/${book}.json to your repo.`}];
      }
      const s = v1 ? v1-1 : 0;
      const e = v2 ? v2-1 : verses.length-1;
      return verses.slice(s, e+1).map((t,i)=>({ n:(s+i+1), t }));
    }

    function versesToHTML(vs){
      return vs.map(v=>`<span class="text-slate-500 text-xs align-top mr-1">${v.n}</span>${escapeHtml(v.t)}`).join(' ');
    }

    // Study rendering
    async function renderStudy(){
      const ref = thisWeekRef();
      const parsed = parseRef(ref);
      document.getElementById('studyRef').innerText = ref + ' (' + state.primary + (state.secondary!=='none'? ' + ' + state.secondary : '') + ')';

      const primary = await getPassage(state.primary, parsed.book, parsed.chapter, parsed.v1, parsed.v2);
      document.getElementById('studyPassageHeading').innerText = `${parsed.book} ${parsed.chapter}:${parsed.v1}${parsed.v2?'‚Äì'+parsed.v2:''} ‚Äî ${state.primary}`;
      document.getElementById('studyPassageText').innerHTML = versesToHTML(primary);

      if(state.secondary!=="none"){
        const sec = await getPassage(state.secondary, parsed.book, parsed.chapter, parsed.v1, parsed.v2);
        document.getElementById('compareBox').classList.remove('hidden');
        document.getElementById('compareText').innerHTML = `<div class="text-slate-500 text-xs">${state.secondary}</div>` + versesToHTML(sec);
      } else {
        document.getElementById('compareBox').classList.add('hidden');
        document.getElementById('compareText').innerHTML = '';
      }

      // Load full chapter context
      await renderChapterContext(parsed);

      // Day lens content
      const dow = ((new Date().getDay()+6)%7)+1; // Mon=1..Sun=7
      renderLens(dow, parsed);

      // Load theology commentary
      await renderTheologians(ref, parsed);

      // Load cross-references
      await renderCrossReferences(ref, parsed);

      // Load notes
      const notesKey = `notes:${ref}`;
      document.getElementById('studyNotes').value = LS.get(notesKey, '');
      document.getElementById('saveNotesBtn').onclick = () => {
        LS.set(notesKey, document.getElementById('studyNotes').value);
        toast('Notes saved');
      };

      document.getElementById('openInBibleBtn').onclick = () => {
        nav('bible');
        openRef(parsed);
      };

      // Setup memorisation mode
      setupMemorisationMode();
    }

    // Render full chapter context
    async function renderChapterContext(parsed) {
      const toggleBtn = document.getElementById('contextToggle');
      const contentEl = document.getElementById('contextContent');
      const chevron = document.getElementById('contextChevron');
      
      // Setup toggle handler
      toggleBtn.onclick = () => {
        const isHidden = contentEl.classList.contains('hidden');
        contentEl.classList.toggle('hidden');
        chevron.textContent = isHidden ? '‚ñ≤' : '‚ñº';
      };

      // Load full chapter in primary version
      const primaryChapter = await getPassage(state.primary, parsed.book, parsed.chapter, null, null);
      document.getElementById('contextPrimaryText').innerHTML = versesToHTML(primaryChapter);

      // Load full chapter in secondary version if set
      if(state.secondary !== 'none') {
        const secondaryChapter = await getPassage(state.secondary, parsed.book, parsed.chapter, null, null);
        document.getElementById('contextCompareBox').classList.remove('hidden');
        document.getElementById('contextCompareText').innerHTML = versesToHTML(secondaryChapter);
      } else {
        document.getElementById('contextCompareBox').classList.add('hidden');
        document.getElementById('contextCompareText').innerHTML = '';
      }
    }

    function renderLens(day, parsed){
      const el = document.getElementById('lensContent');
      const refStr = `${parsed.book} ${parsed.chapter}:${parsed.v1}${parsed.v2?'‚Äì'+parsed.v2:''}`;
      const lenses = {
        1: {
          title: 'Context & Big Picture',
          body: `Read ${refStr} in light of its paragraph and book. Who is speaking? To whom? Where does this fit in the storyline of Scripture? Summarise the flow before and after the verse in 2‚Äì3 bullet points.`
        },
        2: {
          title: 'Translation Compare & Wording',
          body: `Compare ${state.primary} with your secondary translation. Note differences in key verbs and nouns. Which wording clarifies the meaning? Why might translators differ here?`
        },
        3: {
          title: 'Word Study & Key Terms',
          body: `Identify 1‚Äì2 key words in ${refStr}. Define them using a reliable lexicon (e.g., for John 3:16, ‚Äúonly begotten/one and only,‚Äù ‚Äúbelieve,‚Äù ‚Äúeternal life‚Äù). Paraphrase the verse in your own words.`
        },
        4: {
          title: 'Theologians & Traditions',
          body: `How have major voices read this text? For example: Augustine (love and Trinity), Athanasius (Incarnation), Aquinas (virtues and charity), Luther (faith and grace), Calvin (union with Christ), Wesley (holiness). Note agreements and tensions, and what each emphasises.`
        },
        5: {
          title: 'Cross‚ÄëReferences',
          body: `Find 3‚Äì5 cross‚Äëreferences that illuminate ${refStr}. Trace a theme across Scripture (promise‚Üífulfilment, law‚Üígospel, creation‚Üínew creation).`
        },
        6: {
          title: 'Meditation & Prayer',
          body: `Slowly re‚Äëread ${refStr}. What does this reveal about God‚Äôs character? Turn phrases into prayer. Sit in silence for one minute, then write a one‚Äësentence ‚ÄúI will‚Ä¶‚Äù response.`
        },
        7: {
          title: 'Application & Memorisation',
          body: `Commit ${refStr} to memory. Write a practical step for this week (specific, small, time‚Äëbound). Re‚Äëstate the verse as a personal promise or command.`
        }
      };
      const lens = lenses[day];
      el.innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-slate-600">Day ${day} lens</div>
            <h3 class="font-semibold text-lg">${lens.title}</h3>
          </div>
          <div class="text-sm text-slate-500">${new Date().toLocaleDateString()}</div>
        </div>
        <p class="mt-2">${lens.body}</p>
        <div class="mt-3">
          <label class="text-sm font-semibold">Quick prompts</label>
          <ul class="list-disc ml-5 text-sm text-slate-700">
            ${quickPrompts(day, parsed).map(x=>`<li>${x}</li>`).join('')}
          </ul>
        </div>
      `;

      for(const b of document.querySelectorAll('.lensBtn')){
        b.classList.toggle('bg-indigo-600', Number(b.dataset.day)===day);
        b.classList.toggle('text-white', Number(b.dataset.day)===day);
        b.onclick = ()=> renderLens(Number(b.dataset.day), parsed);
      }

      // Update Group Questions box
      const groupBox = document.getElementById('groupQuestionsBox');
      if(state.groupMode){
        groupBox.classList.remove('hidden');
        const questions = generateGroupQuestions(day, parsed);
        document.getElementById('childQuestions').innerHTML = questions.child.map(q=>`<li>${q}</li>`).join('');
        document.getElementById('teenQuestions').innerHTML = questions.teen.map(q=>`<li>${q}</li>`).join('');
        document.getElementById('adultQuestions').innerHTML = questions.adult.map(q=>`<li>${q}</li>`).join('');
        
        // Setup copy button
        document.getElementById('copyForTonightBtn').onclick = async ()=> {
          const ref = thisWeekRef();
          const parsed = parseRef(ref);
          const verses = await getPassage(state.primary, parsed.book, parsed.chapter, parsed.v1, parsed.v2);
          const verseText = verses.map(v=>`${v.n} ${v.t}`).join(' ');
          
          let copyText = `${ref} (${state.primary})\n${verseText}\n\n`;
          copyText += `Group Questions for Tonight:\n\n`;
          copyText += `CHILD:\n${questions.child[0]}\n\n`;
          copyText += `TEEN:\n${questions.teen[0]}\n\n`;
          copyText += `ADULT:\n${questions.adult[0]}\n`;
          
          try {
            await navigator.clipboard.writeText(copyText);
            toast('Copied to clipboard!');
          } catch(err){
            toast('Copy failed - try selecting and copying manually');
          }
        };
      } else {
        groupBox.classList.add('hidden');
      }
    }

    function quickPrompts(day, parsed){
      const book = parsed.book;
      if(day===1) return [
        `Who are the main actors in ${book}?`,
        `What is the immediate question or problem?`,
        `How does this verse move the argument forward?`
      ];
      if(day===2) return [
        `Which words differ between versions?`,
        `What nuance changes if you swap those words?`,
        `Draft a one‚Äësentence meaning that respects both.`
      ];
      if(day===3) return [
        `Circle the key verb(s) and noun(s).`,
        `Check a lexicon (original languages or a good dictionary).`,
        `Write a paraphrase using today‚Äôs terms.`
      ];
      if(day===4) return [
        `What attribute of God is emphasised?`,
        `How do grace and obedience relate here?`,
        `Where do traditions agree; where do they warn?`
      ];
      if(day===5) return [
        `Find earlier echoes in the OT.`,
        `Find fulfilment in Jesus/the Church.`,
        `Find future hope in Revelation.`
      ];
      if(day===6) return [
        `Turn the verse into a prayer.`,
        `Sit in silence (1 min).`,
        `Write a single ‚ÄúI will‚Ä¶‚Äù line.`
      ];
      return [
        `Test your memory: speak it aloud.`,
        `Write one concrete next step for this week.`,
        `Share with a friend for encouragement.`
      ];
    }

    // Generate age-appropriate group questions based on lens
    function generateGroupQuestions(day, parsed){
      const ref = `${parsed.book} ${parsed.chapter}:${parsed.v1}${parsed.v2?'‚Äì'+parsed.v2:''}`;
      
      if(day===1){ // Context
        return {
          child: [
            "Who is talking in this verse?",
            "What happened just before this?",
            "What is the main idea here?"
          ],
          teen: [
            "Who is the speaker and who is listening?",
            "What happened before this verse that helps us understand it?",
            "How does this verse fit into the bigger story of the chapter?"
          ],
          adult: [
            "Who is speaking and what is the historical context?",
            "What theological themes precede this passage?",
            "How does this verse advance the author's argument in the book?"
          ]
        };
      }
      if(day===2){ // Translation
        return {
          child: [
            "Which words sound different between the two versions?",
            "Which version is easier to understand?",
            "Can you say this verse in your own simple words?"
          ],
          teen: [
            "What are the main differences in wording between translations?",
            "Which translation makes the meaning clearer and why?",
            "How would you explain this verse to a friend?"
          ],
          adult: [
            "What key words differ significantly between translations?",
            "What theological implications arise from these translation choices?",
            "How do the original language nuances inform our understanding?"
          ]
        };
      }
      if(day===3){ // Word Study
        return {
          child: [
            "What is the most important word in this verse?",
            "What does that word mean?",
            "Can you use that word in a sentence?"
          ],
          teen: [
            "What are 1-2 key words that stand out to you?",
            "What do these words really mean in this context?",
            "How would you explain this verse using everyday words?"
          ],
          adult: [
            "What are the crucial terms requiring deeper lexical study?",
            "How do these key words function in the original language?",
            "How would you paraphrase this passage preserving theological precision?"
          ]
        };
      }
      if(day===4){ // Theologians
        return {
          child: [
            "What does this verse teach us about God?",
            "What does this verse teach us about people?",
            "Is there something here to thank God for?"
          ],
          teen: [
            "What do these writers agree about in this verse?",
            "What different ideas do they emphasize?",
            "Which perspective helps you understand God better?"
          ],
          adult: [
            "What theological consensus emerges from these voices?",
            "What denominational or traditional differences appear?",
            "How can we hold these perspectives in creative tension?"
          ]
        };
      }
      if(day===5){ // Cross-References
        return {
          child: [
            "Where else in the Bible do we hear about this?",
            "How are these verses connected?",
            "What do both verses teach us?"
          ],
          teen: [
            "Where else does the Bible talk about this idea?",
            "How do these cross-references help explain this verse?",
            "What pattern or theme do you see across these passages?"
          ],
          adult: [
            "How do these cross-references illuminate the passage theologically?",
            "What promise‚Üífulfillment pattern emerges across testaments?",
            "How does this fit into the larger biblical-theological framework?"
          ]
        };
      }
      if(day===6){ // Meditation
        return {
          child: [
            "What in this verse makes you happy?",
            "What can you thank God for from this verse?",
            "What is one thing you can pray about?"
          ],
          teen: [
            "What does this verse reveal about God's character?",
            "How does this verse encourage or challenge you?",
            "What will you pray about after reading this?"
          ],
          adult: [
            "What attributes of God are revealed in this text?",
            "How can you turn this passage into sustained prayer?",
            "What is your 'I will‚Ä¶' response to this meditation?"
          ]
        };
      }
      // day===7: Application
      return {
        child: [
          "What is one thing you learned today?",
          "What can you do this week to remember this verse?",
          "Who can you tell about this verse?"
        ],
        teen: [
          "What is one practical step you can take this week?",
          "How can you apply this verse to your life right now?",
          "Who could you share this verse with and why?"
        ],
        adult: [
          "What specific, measurable action will you take this week?",
          "How does this passage reshape your discipleship priorities?",
          "How can you incarnate this truth in your community?"
        ]
      };
    }

    // Theologians & Traditions rendering
    async function renderTheologians(ref, parsed){
      const cardsEl = document.getElementById('theologiansCards');
      const toggleBtn = document.getElementById('theologiansToggle');
      const contentEl = document.getElementById('theologiansContent');
      const chevron = document.getElementById('theologiansChevron');
      
      // Setup toggle handler
      toggleBtn.onclick = () => {
        const isHidden = contentEl.classList.contains('hidden');
        contentEl.classList.toggle('hidden');
        chevron.textContent = isHidden ? '‚ñ≤' : '‚ñº';
      };

      // Load commentary data
      try {
        const response = await fetch('theology/commentary.json');
        if(!response.ok) throw new Error('File not found');
        const allCommentary = await response.json();
        
        // Filter matching entries
        const matches = allCommentary.filter(entry => matchesRef(entry.ref, ref, parsed));
        
        if(matches.length === 0){
          cardsEl.innerHTML = '<p class="text-sm text-slate-500">No commentary yet for this passage.</p>';
          return;
        }

        // Group by tradition, sort by century
        const grouped = {};
        for(const entry of matches){
          if(!grouped[entry.tradition]) grouped[entry.tradition] = [];
          grouped[entry.tradition].push(entry);
        }
        for(const tradition in grouped){
          grouped[tradition].sort((a,b) => a.century - b.century);
        }

        // Render cards
        let html = '';
        for(const tradition in grouped){
          html += `<div class="mb-4"><h4 class="font-semibold text-sm text-slate-700 mb-2">${escapeHtml(tradition)}</h4>`;
          for(const entry of grouped[tradition]){
            html += renderTheologyCard(entry);
          }
          html += '</div>';
        }
        cardsEl.innerHTML = html;

        // Setup compare voices
        setupCompareVoices(matches);
      } catch(err) {
        cardsEl.innerHTML = '<p class="text-sm text-slate-500">No commentary yet for this passage.</p>';
      }
    }

    function matchesRef(entryRef, currentRef, parsed){
      // Exact match
      if(entryRef === currentRef) return true;
      
      // Parse entry ref to check for overlapping ranges
      const entryParsed = parseRef(entryRef);
      if(!entryParsed || entryParsed.book !== parsed.book) return false;
      if(entryParsed.chapter !== parsed.chapter) return false;
      
      // Check verse overlap for ranges
      const ev1 = entryParsed.v1 || 1;
      const ev2 = entryParsed.v2 || ev1;
      const cv1 = parsed.v1 || 1;
      const cv2 = parsed.v2 || cv1;
      
      return (ev1 <= cv2 && ev2 >= cv1);
    }

    function renderTheologyCard(entry){
      const century = entry.century < 0 ? `${Math.abs(entry.century)} BC` : `${entry.century}th c.`;
      let content = '';
      
      if(entry.mode === 'excerpt' && entry.excerpt){
        content = `<p class="text-sm italic text-slate-700">"${escapeHtml(entry.excerpt)}"</p>`;
      } else if(entry.mode === 'summary' && entry.summary){
        content = `<p class="text-sm text-slate-700">${escapeHtml(entry.summary)}</p>`;
      }

      let takeawaysHtml = '';
      if(entry.takeaways && entry.takeaways.length > 0){
        takeawaysHtml = '<ul class="mt-2 text-xs list-disc ml-4 text-slate-600">';
        for(const t of entry.takeaways){
          takeawaysHtml += `<li>${escapeHtml(t)}</li>`;
        }
        takeawaysHtml += '</ul>';
      }

      return `
        <div class="mb-3 p-3 bg-slate-50 rounded-lg">
          <div class="flex items-start justify-between">
            <div>
              <div class="font-semibold text-sm">${escapeHtml(entry.theologian)}</div>
              <div class="text-xs text-slate-500">${escapeHtml(entry.work)} (${century})</div>
            </div>
          </div>
          <div class="mt-2">
            ${content}
            ${takeawaysHtml}
          </div>
          <div class="mt-2 text-xs">
            <a href="${escapeHtml(entry.url)}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">
              ${escapeHtml(entry.citation)}
            </a>
          </div>
        </div>
      `;
    }

    function setupCompareVoices(matches){
      const toggleBtn = document.getElementById('compareVoicesToggle');
      const contentEl = document.getElementById('compareVoicesContent');
      
      toggleBtn.onclick = () => {
        const isHidden = contentEl.classList.contains('hidden');
        if(isHidden){
          contentEl.innerHTML = generateSynthesis(matches);
          contentEl.classList.remove('hidden');
          toggleBtn.textContent = 'Hide synthesis';
        } else {
          contentEl.classList.add('hidden');
          toggleBtn.textContent = 'Compare voices';
        }
      };
    }

    function generateSynthesis(matches){
      if(matches.length === 0) return '';
      if(matches.length === 1){
        return `<p>${escapeHtml(matches[0].theologian)} offers a ${escapeHtml(matches[0].tradition.toLowerCase())} perspective emphasizing ${escapeHtml(matches[0].takeaways[0]?.toLowerCase() || 'divine truth')}.</p>`;
      }

      // Identify common themes
      const traditions = [...new Set(matches.map(m => m.tradition))];
      const theologians = matches.map(m => m.theologian);
      
      // Build a neutral synthesis
      let synthesis = `Across ${traditions.length > 1 ? traditions.join(' and ') : traditions[0]} tradition${traditions.length > 1 ? 's' : ''}, `;
      synthesis += `${theologians.slice(0, -1).join(', ')}${theologians.length > 2 ? ',' : ''} and ${theologians[theologians.length - 1]} `;
      synthesis += `converge on God's initiative in salvation, yet emphasize different facets. `;
      
      // Highlight specific emphases
      const emphases = matches.map(m => `${m.theologian} stresses ${m.takeaways[0]?.toLowerCase() || 'divine grace'}`);
      synthesis += emphases.join(', while ') + '. ';
      
      // Note tensions or complementarity
      if(traditions.length > 1){
        synthesis += `These voices, though from different eras and contexts, complement one another in presenting the fullness of the gospel message.`;
      } else {
        synthesis += `Together they provide a rich, multi-layered understanding of this passage.`;
      }
      
      return `<p>${escapeHtml(synthesis)}</p>`;
    }

    // Cross-References rendering
    async function renderCrossReferences(ref, parsed){
      const listEl = document.getElementById('xrefsList');
      const toggleBtn = document.getElementById('xrefsToggle');
      const contentEl = document.getElementById('xrefsContent');
      const chevron = document.getElementById('xrefsChevron');
      
      // Setup toggle handler
      toggleBtn.onclick = () => {
        const isHidden = contentEl.classList.contains('hidden');
        contentEl.classList.toggle('hidden');
        chevron.textContent = isHidden ? '‚ñ≤' : '‚ñº';
      };

      // Load cross-references data
      try {
        const response = await fetch(`xrefs/${parsed.book}.json`);
        if(!response.ok) throw new Error('File not found');
        const xrefsData = await response.json();
        
        // Build verse keys for current passage
        const verseKeys = [];
        for(let v = parsed.v1; v <= (parsed.v2 || parsed.v1); v++){
          verseKeys.push(`${parsed.chapter}:${v}`);
        }
        
        // Find matching cross-references
        let allXrefs = [];
        for(const key of verseKeys){
          if(xrefsData[key]){
            allXrefs.push({ verse: key, refs: xrefsData[key] });
          }
        }
        
        if(allXrefs.length === 0){
          listEl.innerHTML = '<p class="text-sm text-slate-500">No cross-references recorded.</p>';
          return;
        }

        // Render cross-references
        let html = '';
        for(const item of allXrefs){
          html += `<div class="mb-4">`;
          if(verseKeys.length > 1){
            html += `<div class="text-sm font-semibold text-slate-700 mb-2">${parsed.book} ${item.verse}</div>`;
          }
          for(const xref of item.refs){
            html += `<div class="mb-2">
              <button class="xref-link text-sm text-indigo-600 hover:underline" data-ref="${escapeHtml(xref)}">${escapeHtml(xref)}</button>
              <div class="xref-preview hidden mt-2 ml-4 p-3 bg-slate-50 rounded-lg border-l-2 border-indigo-400" data-ref="${escapeHtml(xref)}"></div>
            </div>`;
          }
          html += `</div>`;
        }
        listEl.innerHTML = html;

        // Attach click handlers for inline previews
        for(const link of listEl.querySelectorAll('.xref-link')){
          link.onclick = async (e) => {
            e.preventDefault();
            const xref = link.dataset.ref;
            const previewEl = listEl.querySelector(`.xref-preview[data-ref="${CSS.escape(xref)}"]`);
            
            if(!previewEl.classList.contains('hidden')){
              previewEl.classList.add('hidden');
              return;
            }

            // Load and display preview
            const xrefParsed = parseRef(xref);
            if(!xrefParsed){
              previewEl.innerHTML = '<p class="text-sm text-red-600">Invalid reference format.</p>';
              previewEl.classList.remove('hidden');
              return;
            }

            // Fetch 1-2 verses in primary translation
            const limit = xrefParsed.v2 ? Math.min(xrefParsed.v2, xrefParsed.v1 + 1) : xrefParsed.v1;
            const primary = await getPassage(state.primary, xrefParsed.book, xrefParsed.chapter, xrefParsed.v1, limit);
            
            let previewHtml = `<div class="text-xs text-slate-500 mb-1">${escapeHtml(xref)} ‚Äî ${state.primary}</div>`;
            previewHtml += `<div class="text-sm">${versesToHTML(primary)}</div>`;
            
            // If secondary translation is set, show compare line
            if(state.secondary !== 'none'){
              const secondary = await getPassage(state.secondary, xrefParsed.book, xrefParsed.chapter, xrefParsed.v1, limit);
              previewHtml += `<div class="mt-2 pt-2 border-t text-xs text-slate-600">
                <span class="text-slate-500">${state.secondary}:</span> ${versesToHTML(secondary)}
              </div>`;
            }
            
            previewHtml += `<div class="mt-2">
              <button class="open-in-bible px-2 py-1 rounded bg-indigo-600 text-white text-xs hover:bg-indigo-500" data-ref="${escapeHtml(xref)}">Open in Bible</button>
            </div>`;
            
            previewEl.innerHTML = previewHtml;
            previewEl.classList.remove('hidden');

            // Attach "Open in Bible" handler
            const openBtn = previewEl.querySelector('.open-in-bible');
            openBtn.onclick = () => {
              nav('bible');
              openRef(xrefParsed);
            };
          };
        }
      } catch(err) {
        listEl.innerHTML = '<p class="text-sm text-slate-500">No cross-references recorded.</p>';
      }
    }

    // Bible view
    function showBooks(which){
      const cont = document.getElementById('books');
      cont.innerHTML = '';
      for(const b of BOOKS[which]){
        const btn = document.createElement('button');
        btn.className = 'px-3 py-2 rounded-lg bg-slate-200';
        btn.textContent = b;
        btn.onclick = ()=> showChapters(b);
        cont.appendChild(btn);
      }
      document.getElementById('chapters').innerHTML = '';
      document.getElementById('verses').innerHTML = '';
    }

    async function showChapters(book){
      const chaptersEl = document.getElementById('chapters');
      chaptersEl.innerHTML = '';
      // Try to guess chapter count from sample or fallback to 50
      const chs = SAMPLE[state.primary]?.[book] ? Object.keys(SAMPLE[state.primary][book]).map(Number) : Array.from({length:50}, (_,i)=>i+1);
      const maxCh = Math.max(...chs);
      for(let i=1;i<=Math.min(maxCh,150);i++){
        const b = document.createElement('button');
        b.className = 'px-2 py-1 rounded bg-slate-100';
        b.textContent = i;
        b.onclick = ()=> showChapter(book, i);
        chaptersEl.appendChild(b);
      }
      document.getElementById('verses').innerHTML = '';
    }

    async function showChapter(book, chapter){
      const versesEl = document.getElementById('verses');
      versesEl.innerHTML = '<div class="text-sm text-slate-500">Loading‚Ä¶</div>';
      const vs = await getPassage(state.primary, book, chapter, null, null);
      const secVs = state.secondary!=='none' ? await getPassage(state.secondary, book, chapter, null, null) : null;
      const pairs = vs.map((v,i)=>({ n:v.n, a:v.t, b: secVs? (secVs[i]?.t||'') : null }));
      versesEl.innerHTML = pairs.map(p=>`
        <div class="p-3 rounded-xl bg-slate-50" id="verse-${p.n}">
          <div class="text-slate-500 text-xs">${book} ${chapter}:${p.n}</div>
          <div class="mt-1">${escapeHtml(p.a)}</div>
          ${p.b!==null ? `<div class="mt-2 text-sm border-t pt-2"><span class="text-slate-500 text-xs">${state.secondary}</span><br>${escapeHtml(p.b)}</div>`:''}
        </div>
      `).join('');
    }

    function openRef(parsed){
      // Open navigator to book/chapter and scroll to the focus verse
      const which = BOOKS.NT.includes(parsed.book) ? 'NT' : 'OT';
      showBooks(which);
      showChapters(parsed.book);
      showChapter(parsed.book, Number(parsed.chapter));
      setTimeout(()=> {
        const verseId = `verse-${parsed.v1 || 1}`;
        const target = document.getElementById(verseId);
        if(target) {
          target.scrollIntoView({behavior:'smooth', block:'center'});
          // Briefly highlight the verse
          target.classList.add('ring-2', 'ring-indigo-400');
          setTimeout(() => target.classList.remove('ring-2', 'ring-indigo-400'), 2000);
        }
      }, 300);
    }

    // Export/import for user data
    document.getElementById('exportBtn').onclick = () => {
      const data = {
        state: {
          primary: state.primary,
          secondary: state.secondary,
          startDate: state.startDate,
          groupMode: state.groupMode
        }
      };
      
      // Add all notes:* and memory:* keys
      for(let i=0; i<localStorage.length; i++){
        const k = localStorage.key(i);
        if(k.startsWith('notes:') || k.startsWith('memory:')){
          data[k] = localStorage.getItem(k);
        }
      }
      
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'bible-study-data.json';
      a.click();
    };
    
    document.getElementById('importInput').onchange = async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const text = await file.text();
      try {
        const obj = JSON.parse(text);
        
        // Import state object
        if(obj.state){
          state.primary = obj.state.primary || state.primary;
          state.secondary = obj.state.secondary || state.secondary;
          state.startDate = obj.state.startDate || state.startDate;
          state.groupMode = obj.state.groupMode || state.groupMode;
          LS.set('state', state);
        }
        
        // Import notes:* and memory:* keys
        for(const [k,v] of Object.entries(obj)){
          if(k.startsWith('notes:') || k.startsWith('memory:')){
            localStorage.setItem(k, v);
          }
        }
        
        // Update UI
        primaryVersion.value = state.primary;
        secondaryVersion.value = state.secondary;
        groupModeToggle.checked = state.groupMode;
        
        toast('Imported');
        renderHome();
        renderStudy();
      } catch {
        toast('Import failed');
      }
    };

    // Today button: jump to study
    document.getElementById('todayBtn').onclick = ()=> nav('study');

    // Random blessing line in drawer
    const blessings = [
      'Psalm 119:105', 'Numbers 6:24-26', 'Philippians 4:7', 'Romans 15:13', 'Jude 24-25'
    ];
    function setBlessing(){
      const r = blessings[Math.floor(Math.random()*blessings.length)];
      const p = parseRef(r);
      if (!p) return;
      getPassage('KJV', p.book, p.chapter, p.v1, p.v2).then(vs => {
        document.getElementById('randomBlessing').innerHTML = `‚Äú${escapeHtml(vs.map(x=>x.t).join(' '))}‚Äù ‚Äî ${r}`;
      
      }).catch(() => {
        document.getElementById("randomBlessing").innerHTML = `"Your word is a lamp unto my feet, and a light unto my path." ‚Äî Psalm 119:105`;
      });
    }

    // Memorisation Mode
    let memoryState = {
      mode: 'hide', // 'hide' or 'first-letters'
      difficulty: 40,
      timerActive: false,
      timerInterval: null,
      timerRemaining: 0
    };

    // Seeded random number generator for deterministic masking
    function seededRandom(seed) {
      let m = 0x80000000; // 2^31
      let a = 1103515245;
      let c = 12345;
      let state = seed ? seed : Math.floor(Math.random() * (m - 1));
      return function() {
        state = (a * state + c) % m;
        return state / (m - 1);
      };
    }

    // Generate seed from ref + day
    function getSeed(ref) {
      const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
      const str = ref + today;
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash = hash & hash; // Convert to 32bit integer
      }
      return Math.abs(hash);
    }

    // Mask text based on mode and difficulty percentage
    function maskText(text, mode, percent) {
      const words = text.split(/(\s+|[.,;:!?‚Äî"'()[\]{}])/);
      const seed = getSeed(thisWeekRef());
      const rng = seededRandom(seed);
      
      const masked = words.map(word => {
        // Skip whitespace and punctuation
        if (!word || /^\s+$/.test(word) || /^[.,;:!?‚Äî"'()[\]{}]+$/.test(word)) {
          return word;
        }
        
        // Apply masking based on random threshold
        if (rng() * 100 < percent) {
          if (mode === 'hide') {
            // Replace with underscores matching word length
            return '_'.repeat(word.length);
          } else if (mode === 'first-letters') {
            // Keep first letter + dots
            if (word.length === 1) return word;
            return word[0] + '.'.repeat(word.length - 1);
          }
        }
        return word;
      });
      
      return masked.join('');
    }

    // Setup Memorisation Mode
    function setupMemorisationMode() {
      const toggleBtn = document.getElementById('memorisationToggle');
      const contentEl = document.getElementById('memorisationContent');
      const chevron = document.getElementById('memorisationChevron');
      const modeHideBtn = document.getElementById('modeHide');
      const modeFirstLettersBtn = document.getElementById('modeFirstLetters');
      const difficultySlider = document.getElementById('difficultySlider');
      const difficultyLabel = document.getElementById('difficultyLabel');
      const timerBtns = document.querySelectorAll('.timerBtn');
      const timerStopBtn = document.getElementById('timerStop');
      const timerDisplay = document.getElementById('timerDisplay');
      const memoryStats = document.getElementById('memoryStats');
      const memoryStatsContent = document.getElementById('memoryStatsContent');
      
      // Toggle panel
      toggleBtn.onclick = () => {
        const isHidden = contentEl.classList.contains('hidden');
        contentEl.classList.toggle('hidden');
        chevron.textContent = isHidden ? '‚ñ≤' : '‚ñº';
        if (!isHidden) {
          // Reset display when closing
          applyMemoryMask(false);
          stopTimer();
        } else {
          // Apply mask when opening
          applyMemoryMask(true);
          loadMemoryStats();
        }
      };

      // Mode selection
      modeHideBtn.onclick = () => {
        memoryState.mode = 'hide';
        modeHideBtn.className = 'px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm';
        modeFirstLettersBtn.className = 'px-3 py-2 rounded-lg bg-slate-200 text-sm';
        applyMemoryMask(true);
      };
      
      modeFirstLettersBtn.onclick = () => {
        memoryState.mode = 'first-letters';
        modeFirstLettersBtn.className = 'px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm';
        modeHideBtn.className = 'px-3 py-2 rounded-lg bg-slate-200 text-sm';
        applyMemoryMask(true);
      };

      // Difficulty slider
      difficultySlider.oninput = () => {
        memoryState.difficulty = parseInt(difficultySlider.value);
        difficultyLabel.textContent = memoryState.difficulty + '%';
        applyMemoryMask(true);
      };

      // Timer buttons
      timerBtns.forEach(btn => {
        btn.onclick = () => {
          const seconds = parseInt(btn.dataset.seconds);
          startTimer(seconds);
        };
      });

      timerStopBtn.onclick = () => {
        stopTimer();
      };
    }

    function applyMemoryMask(enabled) {
      const passageTextEl = document.getElementById('studyPassageText');
      if (!passageTextEl) return;
      
      if (!enabled || document.getElementById('memorisationContent').classList.contains('hidden')) {
        // Restore original passage
        renderStudy();
        return;
      }

      // Get current passage text from verses
      const ref = thisWeekRef();
      const parsed = parseRef(ref);
      
      getPassage(state.primary, parsed.book, parsed.chapter, parsed.v1, parsed.v2).then(verses => {
        const maskedHTML = verses.map(v => {
          const maskedText = maskText(v.t, memoryState.mode, memoryState.difficulty);
          return `<span class="text-slate-500 text-xs align-top mr-1">${v.n}</span>${escapeHtml(maskedText)}`;
        }).join(' ');
        
        passageTextEl.innerHTML = maskedHTML;
      });
    }

    function startTimer(seconds) {
      stopTimer(); // Clear any existing timer
      
      memoryState.timerActive = true;
      memoryState.timerRemaining = seconds;
      
      const timerDisplay = document.getElementById('timerDisplay');
      const timerStopBtn = document.getElementById('timerStop');
      
      timerDisplay.classList.remove('hidden');
      timerStopBtn.classList.remove('hidden');
      
      updateTimerDisplay();
      
      memoryState.timerInterval = setInterval(() => {
        memoryState.timerRemaining--;
        updateTimerDisplay();
        
        if (memoryState.timerRemaining <= 0) {
          stopTimer();
          toast('Time\'s up!');
          saveMemoryAttempt(seconds);
        }
      }, 1000);
    }

    function stopTimer() {
      if (memoryState.timerInterval) {
        clearInterval(memoryState.timerInterval);
        memoryState.timerInterval = null;
      }
      
      memoryState.timerActive = false;
      
      const timerDisplay = document.getElementById('timerDisplay');
      const timerStopBtn = document.getElementById('timerStop');
      
      timerDisplay.classList.add('hidden');
      timerStopBtn.classList.add('hidden');
    }

    function updateTimerDisplay() {
      const timerDisplay = document.getElementById('timerDisplay');
      const minutes = Math.floor(memoryState.timerRemaining / 60);
      const seconds = memoryState.timerRemaining % 60;
      timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // Color coding
      if (memoryState.timerRemaining <= 10) {
        timerDisplay.className = 'mt-2 text-2xl font-bold text-center text-red-600';
      } else if (memoryState.timerRemaining <= 30) {
        timerDisplay.className = 'mt-2 text-2xl font-bold text-center text-orange-600';
      } else {
        timerDisplay.className = 'mt-2 text-2xl font-bold text-center text-indigo-600';
      }
    }

    function saveMemoryAttempt(timeUsed) {
      const ref = thisWeekRef();
      const key = `memory:${ref}`;
      const stats = LS.get(key, { mode: memoryState.mode, bestTime: null, lastPercent: memoryState.difficulty });
      
      // Update best time if this is better (completed faster)
      if (!stats.bestTime || timeUsed < stats.bestTime) {
        stats.bestTime = timeUsed;
        stats.mode = memoryState.mode;
        stats.lastPercent = memoryState.difficulty;
        LS.set(key, stats);
        toast(`New best time: ${timeUsed}s!`);
        loadMemoryStats();
      }
    }

    function loadMemoryStats() {
      const ref = thisWeekRef();
      const key = `memory:${ref}`;
      const stats = LS.get(key, null);
      const memoryStats = document.getElementById('memoryStats');
      const memoryStatsContent = document.getElementById('memoryStatsContent');
      
      if (stats && stats.bestTime) {
        memoryStatsContent.innerHTML = `
          <div class="text-xs text-slate-600">Mode: ${stats.mode === 'hide' ? 'Hide words' : 'First letters'}</div>
          <div class="text-xs text-slate-600">Best time: ${stats.bestTime}s</div>
          <div class="text-xs text-slate-600">Difficulty: ${stats.lastPercent}%</div>
        `;
        memoryStats.classList.remove('hidden');
      } else {
        memoryStats.classList.add('hidden');
      }
    }

    // Helpers
    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      t.className = 'fixed bottom-16 left-1/2 -translate-x-1/2 px-3 py-2 rounded-lg bg-slate-900 text-white shadow';
      document.body.appendChild(t);
      setTimeout(()=> t.remove(), 1800);
    }
    function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])) }

    // Initial render
    renderHome();
    renderStudy();
    setBlessing();

    // Service Worker Registration with Update Prompt
    if ('serviceWorker' in navigator) {
      let refreshing = false;
      
      // Reload page when new service worker takes control
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        refreshing = true;
        window.location.reload();
      });

      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('Service Worker registered successfully:', registration.scope);
            
            // Check for updates periodically
            setInterval(() => {
              registration.update();
            }, 60000); // Check every minute

            // When a new SW is waiting, show update prompt
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New service worker is installed but waiting
                  showUpdatePrompt(registration);
                }
              });
            });

            // Check if there's already a waiting service worker
            if (registration.waiting) {
              showUpdatePrompt(registration);
            }
          })
          .catch((error) => {
            console.error('Service Worker registration failed:', error);
          });
      });
    }

    // Show update prompt toast
    function showUpdatePrompt(registration) {
      const updateToast = document.createElement('div');
      updateToast.id = 'updateToast';
      updateToast.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 px-4 py-3 rounded-lg bg-indigo-600 text-white shadow-lg flex items-center gap-3 z-50';
      updateToast.innerHTML = `
        <span class="text-sm font-medium">Update available</span>
        <button id="reloadBtn" class="px-3 py-1 rounded bg-white text-indigo-600 font-medium text-sm hover:bg-indigo-50 active:scale-95">
          Reload
        </button>
      `;
      document.body.appendChild(updateToast);

      document.getElementById('reloadBtn').onclick = () => {
        if (registration.waiting) {
          // Tell the waiting service worker to skip waiting
          registration.waiting.postMessage({ type: 'SKIP_WAITING' });
        }
      };
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bible Study (Weekly Deep-Dive)</title>
  <!-- Tailwind via CDN for a clean, mobile‑first UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" href="/assets/icon-192.svg" type="image/svg+xml" />
  <style>
    /* Utility tweaks for mobile */
    .safe { padding-bottom: env(safe-area-inset-bottom); }
    .scroll-snap-x { scroll-snap-type: x mandatory; }
    .snap-center { scroll-snap-align: center; }
    .thin { scrollbar-width: thin; }
    /* Hide number input spinners on mobile */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="bg-slate-100 text-slate-900">
  <!-- Top bar -->
  <header class="sticky top-0 z-30 bg-slate-900 text-white shadow">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <button id="menuBtn" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 active:scale-[0.98]" aria-label="Open menu">☰</button>
      <h1 class="font-semibold">Bible Study</h1>
      <button id="todayBtn" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 active:scale-[0.98]">Today</button>
    </div>
  </header>

  <!-- Drawer / Menu -->
  <aside id="drawer" class="fixed inset-0 z-40 hidden">
    <div class="absolute inset-0 bg-black/40" id="drawerBackdrop"></div>
    <div class="absolute left-0 top-0 h-full w-[90%] max-w-sm bg-white shadow-xl p-4 overflow-y-auto thin">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Menu</h2>
        <button id="drawerClose" class="p-2 rounded hover:bg-slate-100" aria-label="Close">✕</button>
      </div>

      <div class="mt-4 space-y-6">
        <section>
          <h3 class="font-semibold text-slate-700">Bible Translation</h3>
          <p class="text-sm text-slate-500 mb-2">Choose your primary reading translation. (KJV and WEB are included; more can be added.)</p>
          <select id="primaryVersion" class="w-full border rounded-lg p-2">
            <option value="KJV">KJV (Public Domain)</option>
            <option value="WEB">WEB — World English Bible (PD)</option>
          </select>
          <label class="block mt-3 text-sm text-slate-600">
            Secondary (for compare):
            <select id="secondaryVersion" class="w-full border rounded-lg p-2 mt-1">
              <option value="none">None</option>
              <option value="WEB">WEB</option>
              <option value="KJV">KJV</option>
            </select>
          </label>
        </section>

        <section>
          <h3 class="font-semibold text-slate-700">Study Rhythm</h3>
          <p class="text-sm text-slate-500">A weekly focus on a single verse or short passage, with a different pedagogical lens each day.</p>
          <ul class="text-sm list-disc ml-5 text-slate-600">
            <li>Mon — Context & big picture</li>
            <li>Tue — Translation compare & wording</li>
            <li>Wed — Word study & key terms</li>
            <li>Thu — Theologians & traditions</li>
            <li>Fri — Cross‑references</li>
            <li>Sat — Meditation & prayer</li>
            <li>Sun — Application & memorisation</li>
          </ul>
        </section>

        <section>
          <h3 class="font-semibold text-slate-700">Statement</h3>
          <p class="text-sm text-slate-600">This app aims to help Christians know the Scriptures deeply and devotionally. It presents multiple perspectives from the historic church while encouraging prayerful discernment.</p>
          <blockquote class="mt-2 border-l-4 border-indigo-400 pl-3 italic text-sm text-slate-700" id="randomBlessing">
            "Your word is a lamp unto my feet, and a light unto my path." — Psalm 119:105
          </blockquote>
        </section>

        <section>
          <h3 class="font-semibold text-slate-700">Data & Privacy</h3>
          <p class="text-sm text-slate-600">All notes are stored on your device using localStorage. You can export/import below.</p>
          <div class="mt-2 flex gap-2">
            <button id="exportBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Export Notes</button>
            <label class="px-3 py-2 rounded-lg bg-slate-200 cursor-pointer">Import<input id="importInput" type="file" accept="application/json" class="hidden"/></label>
          </div>
        </section>

      </div>
    </div>
  </aside>

  <!-- Main pages -->
  <main class="max-w-3xl mx-auto p-4 space-y-4">
    <!-- Home -->
    <section id="home" class="">
      <div class="flex flex-col gap-4">
        <div class="rounded-2xl bg-gradient-to-br from-indigo-600 to-sky-500 text-white p-5 shadow">
          <h2 class="text-xl font-semibold">This Week</h2>
          <p class="opacity-90" id="thisWeekRef">Loading…</p>
          <p class="mt-2 text-sm opacity-90" id="thisWeekSummary">Plan: different focus each day to saturate in the passage.</p>
          <div class="mt-3 flex gap-2">
            <button class="px-3 py-2 rounded-lg bg-white/20 hover:bg-white/30" onclick="nav('study')">Open Study</button>
            <button class="px-3 py-2 rounded-lg bg-white/20 hover:bg-white/30" onclick="nav('bible')">Open Bible</button>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button class="rounded-2xl p-4 bg-white shadow active:scale-[0.99]" onclick="nav('study')">
            <div class="text-2xl">📖</div>
            <div class="font-semibold">This Week’s Study</div>
            <div class="text-sm text-slate-600">Daily prompts, notes, compare translations.</div>
          </button>
          <button class="rounded-2xl p-4 bg-white shadow active:scale-[0.99]" onclick="nav('bible')">
            <div class="text-2xl">📚</div>
            <div class="font-semibold">Bible</div>
            <div class="text-sm text-slate-600">Navigate by Testament → Book → Chapter.</div>
          </button>
        </div>
      </div>
    </section>

    <!-- Study -->
    <section id="study" class="hidden">
      <div class="rounded-2xl bg-white shadow p-4">
        <div class="flex items-center justify-between gap-2">
          <div>
            <h2 class="font-semibold">Weekly Study</h2>
            <p class="text-sm text-slate-600" id="studyRef"></p>
          </div>
          <button class="text-sm px-3 py-2 rounded-lg bg-indigo-600 text-white" id="openInBibleBtn">Open in Bible</button>
        </div>

        <!-- Day lenses -->
        <div class="mt-3 flex overflow-x-auto gap-2 scroll-snap-x thin">
          <button data-day="1" class="lensBtn snap-center px-3 py-2 rounded-full bg-slate-200">Mon</button>
          <button data-day="2" class="lensBtn snap-center px-3 py-2 rounded-full bg-slate-200">Tue</button>
          <button data-day="3" class="lensBtn snap-center px-3 py-2 rounded-full bg-slate-200">Wed</button>
          <button data-day="4" class="lensBtn snap-center px-3 py-2 rounded-full bg-slate-200">Thu</button>
          <button data-day="5" class="lensBtn snap-center px-3 py-2 rounded-full bg-slate-200">Fri</button>
          <button data-day="6" class="lensBtn snap-center px-3 py-2 rounded-full bg-slate-200">Sat</button>
          <button data-day="7" class="lensBtn snap-center px-3 py-2 rounded-full bg-slate-200">Sun</button>
        </div>

        <div class="mt-4 space-y-4">
          <div class="p-3 bg-slate-50 rounded-xl" id="studyPassageBox">
            <div class="text-sm text-slate-600" id="studyPassageHeading"></div>
            <div id="studyPassageText" class="mt-2 leading-relaxed"></div>
            <div id="compareBox" class="mt-2 border-t pt-2 hidden">
              <div class="text-sm font-semibold">Compare</div>
              <div id="compareText" class="text-sm mt-1"></div>
            </div>
          </div>

          <div class="p-3 bg-slate-50 rounded-xl" id="lensContent">
            <!-- dynamic prompts / content per day -->
          </div>

          <div>
            <label class="block text-sm font-semibold">Your notes</label>
            <textarea id="studyNotes" class="w-full mt-1 border rounded-lg p-3 h-36" placeholder="Write prayers, observations, connections…"></textarea>
            <div class="mt-2 text-right">
              <button id="saveNotesBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Save Notes</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Bible Navigator -->
    <section id="bible" class="hidden">
      <div class="rounded-2xl bg-white shadow p-4">
        <h2 class="font-semibold">Bible</h2>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <button class="px-3 py-2 rounded-lg bg-slate-200" onclick="showBooks('OT')">Old Testament</button>
          <button class="px-3 py-2 rounded-lg bg-slate-200" onclick="showBooks('NT')">New Testament</button>
        </div>

        <div id="books" class="mt-3 grid grid-cols-2 gap-2"></div>
        <div id="chapters" class="mt-3 grid grid-cols-6 gap-2"></div>
        <div id="verses" class="mt-3 space-y-3"></div>
      </div>
    </section>
  </main>

  <!-- Footer nav -->
  <footer class="fixed bottom-0 inset-x-0 bg-white border-t safe">
    <div class="max-w-3xl mx-auto px-4 py-2 grid grid-cols-3 gap-2">
      <button class="p-2 rounded-lg hover:bg-slate-100" onclick="nav('home')">Home</button>
      <button class="p-2 rounded-lg hover:bg-slate-100" onclick="nav('study')">Study</button>
      <button class="p-2 rounded-lg hover:bg-slate-100" onclick="nav('bible')">Bible</button>
    </div>
  </footer>

  <script>
    /*********************
     * Minimal Bible Data *
     * ------------------ *
     * To keep this single-file demo small, only a few chapters are embedded
     * (John 1 & 3 KJV/WEB, Psalm 23 KJV/WEB). The app is designed to load
     * full Bible JSON files if you add them to your repo later.
     *
     * HOW TO ADD FULL BIBLES (optional):
     * 1) Create /bibles/KJV/ and /bibles/WEB/ folders in your repo.
     * 2) Put JSON files named like "John.json", "Matthew.json", etc., where each file maps chapter→verse arrays.
     *    Example schema:
     *    {
     *      "1": ["In the beginning ...", "He was ..."],
     *      "2": ["On the third day ..."]
     *    }
     * 3) This index will try to fetch them on demand. If not found, it falls back to the embedded samples.
     */

    const BOOKS = {
      OT: [
        "Genesis","Exodus","Leviticus","Numbers","Deuteronomy","Joshua","Judges","Ruth","1 Samuel","2 Samuel","1 Kings","2 Kings","1 Chronicles","2 Chronicles","Ezra","Nehemiah","Esther","Job","Psalms","Proverbs","Ecclesiastes","Song of Solomon","Isaiah","Jeremiah","Lamentations","Ezekiel","Daniel","Hosea","Joel","Amos","Obadiah","Jonah","Micah","Nahum","Habakkuk","Zephaniah","Haggai","Zechariah","Malachi"
      ],
      NT: [
        "Matthew","Mark","Luke","John","Acts","Romans","1 Corinthians","2 Corinthians","Galatians","Ephesians","Philippians","Colossians","1 Thessalonians","2 Thessalonians","1 Timothy","2 Timothy","Titus","Philemon","Hebrews","James","1 Peter","2 Peter","1 John","2 John","3 John","Jude","Revelation"
      ]
    };

    // Embedded sample passages (KJV + WEB)
    const SAMPLE = {
      KJV: {
        Psalms: {"23": [
          "The LORD is my shepherd; I shall not want.",
          "He maketh me to lie down in green pastures: he leadeth me beside the still waters.",
          "He restoreth my soul: he leadeth me in the paths of righteousness for his name's sake.",
          "Yea, though I walk through the valley of the shadow of death, I will fear no evil: for thou art with me; thy rod and thy staff they comfort me.",
          "Thou preparest a table before me in the presence of mine enemies: thou anointest my head with oil; my cup runneth over.",
          "Surely goodness and mercy shall follow me all the days of my life: and I will dwell in the house of the LORD for ever."
        ]},
        John: {"1": [
          "In the beginning was the Word, and the Word was with God, and the Word was God.",
          "The same was in the beginning with God.",
          "All things were made by him; and without him was not any thing made that was made.",
          "In him was life; and the life was the light of men.",
          "And the light shineth in darkness; and the darkness comprehended it not."
        ],
        "3": [
          "There was a man of the Pharisees, named Nicodemus, a ruler of the Jews:",
          "The same came to Jesus by night, and said unto him, Rabbi, we know that thou art a teacher come from God: for no man can do these miracles that thou doest, except God be with him.",
          "Jesus answered and said unto him, Verily, verily, I say unto thee, Except a man be born again, he cannot see the kingdom of God.",
          "Nicodemus saith unto him, How can a man be born when he is old? can he enter the second time into his mother's womb, and be born?",
          "Jesus answered, Verily, verily, I say unto thee, Except a man be born of water and of the Spirit, he cannot enter into the kingdom of God.",
          "That which is born of the flesh is flesh; and that which is born of the Spirit is spirit.",
          "Marvel not that I said unto thee, Ye must be born again.",
          "The wind bloweth where it listeth, and thou hearest the sound thereof, but canst not tell whence it cometh, and whither it goeth: so is every one that is born of the Spirit.",
          "Nicodemus answered and said unto him, How can these things be?",
          "Jesus answered and said unto him, Art thou a master of Israel, and knowest not these things?",
          "Verily, verily, I say unto thee, We speak that we do know, and testify that we have seen; and ye receive not our witness.",
          "If I have told you earthly things, and ye believe not, how shall ye believe, if I tell you of heavenly things?",
          "And no man hath ascended up to heaven, but he that came down from heaven, even the Son of man which is in heaven.",
          "And as Moses lifted up the serpent in the wilderness, even so must the Son of man be lifted up:",
          "That whosoever believeth in him should not perish, but have eternal life.",
          "For God so loved the world, that he gave his only begotten Son, that whosoever believeth in him should not perish, but have everlasting life."
        ]}},
      WEB: {
        Psalms: {"23": [
          "Yahweh is my shepherd: I shall lack nothing.",
          "He makes me lie down in green pastures. He leads me beside still waters.",
          "He restores my soul. He guides me in the paths of righteousness for his name’s sake.",
          "Even though I walk through the valley of the shadow of death, I will fear no evil, for you are with me. Your rod and your staff, they comfort me.",
          "You prepare a table before me in the presence of my enemies. You anoint my head with oil. My cup runs over.",
          "Surely goodness and loving kindness shall follow me all the days of my life, and I will dwell in Yahweh’s house forever."
        ]},
        John: {"1": [
          "In the beginning was the Word, and the Word was with God, and the Word was God.",
          "The same was in the beginning with God.",
          "All things were made through him. Without him, nothing was made that has been made.",
          "In him was life, and the life was the light of men.",
          "The light shines in the darkness, and the darkness hasn’t overcome it."
        ],
        "3": [
          "Now there was a man of the Pharisees named Nicodemus, a ruler of the Jews.",
          "The same came to him by night, and said to him, “Rabbi, we know that you are a teacher come from God, for no one can do these signs that you do, unless God is with him.”",
          "Jesus answered him, “Most certainly, I tell you, unless one is born anew, he can’t see God’s Kingdom.”",
          "Nicodemus said to him, “How can a man be born when he is old? Can he enter a second time into his mother’s womb, and be born?”",
          "Jesus answered, “Most certainly I tell you, unless one is born of water and spirit, he can’t enter into God’s Kingdom.",
          "That which is born of the flesh is flesh. That which is born of the Spirit is spirit.",
          "Don’t marvel that I said to you, ‘You must be born anew.’",
          "The wind blows where it wants to, and you hear its sound, but don’t know where it comes from and where it is going. So is everyone who is born of the Spirit.”",
          "Nicodemus answered him, “How can these things be?”",
          "Jesus answered him, “Are you the teacher of Israel, and don’t understand these things?",
          "Most certainly I tell you, we speak that which we know, and testify of that which we have seen, and you don’t receive our witness.",
          "If I told you earthly things and you don’t believe, how will you believe if I tell you heavenly things?",
          "No one has ascended into heaven but he who descended out of heaven, the Son of Man, who is in heaven.",
          "As Moses lifted up the serpent in the wilderness, even so must the Son of Man be lifted up,",
          "that whoever believes in him should not perish, but have eternal life.",
          "For God so loved the world that he gave his one and only Son, that whoever believes in him should not perish, but have eternal life."
        ]}}
    };

// Weekly "big verses" — start with the core 10 verses (NT first), then additional verses
    const BIG_VERSES = [
      "John 1:1",
      "John 3:16",
      "Matthew 28:18-20",
      "Romans 5:8",
      "Romans 8:28-30",
      "1 Corinthians 13:4-7",
      "Ephesians 2:8-10",
      "Philippians 2:5-11",
      "Psalms 23:1-6",
      "Isaiah 53:4-6"
    ];

    // Local storage helpers
    const LS = {
      get(k, d=null){ try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d }},
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)) }
    };

    // State
    let state = LS.get('state', {
      primary: 'WEB',
      secondary: 'none',
      startDate: '2025-01-06', // Monday week 1 anchor; change as desired
    });

    // Basic navigation
    function nav(id){
      for(const sec of document.querySelectorAll('main > section')) sec.classList.add('hidden');
      document.getElementById(id).classList.remove('hidden');
      if(id==='study') renderStudy();
    }

    // Drawer
    const drawer = {
      open(){ document.getElementById('drawer').classList.remove('hidden') },
      close(){ document.getElementById('drawer').classList.add('hidden') }
    };
    document.getElementById('menuBtn').onclick = drawer.open;
    document.getElementById('drawerBackdrop').onclick = drawer.close;
    document.getElementById('drawerClose').onclick = drawer.close;

    // Version selectors
    const primaryVersion = document.getElementById('primaryVersion');
    const secondaryVersion = document.getElementById('secondaryVersion');
    primaryVersion.value = state.primary;
    secondaryVersion.value = state.secondary;
    primaryVersion.onchange = () => { state.primary = primaryVersion.value; LS.set('state', state); renderStudy(); };
    secondaryVersion.onchange = () => { state.secondary = secondaryVersion.value; LS.set('state', state); renderStudy(); };

    // Weekly selection (based on weeks since startDate)
    function weekIndex(){
      const start = new Date(state.startDate + 'T00:00:00');
      const now = new Date();
      const diff = Math.floor((now - start) / (1000*60*60*24*7));
      return ((diff % BIG_VERSES.length) + BIG_VERSES.length) % BIG_VERSES.length;
    }

    function thisWeekRef(){ return BIG_VERSES[weekIndex()] }

    // Render home card
    function renderHome(){
      document.getElementById('thisWeekRef').innerText = thisWeekRef();
    }

    // Parse ref like "John 3:16" or "Matthew 5:3-10"
    function parseRef(ref){
      const m = ref.match(/^(.*?)\s+(\d+)(?::(\d+)(?:-(\d+))?)?$/);
      if(!m) return null;
      return { book: m[1], chapter: m[2], v1: m[3] ? +m[3] : 1, v2: m[4] ? +m[4] : (m[3]?+m[3]:null) };
    }

    // Load verses (tries fetch from /bibles/{ver}/{Book}.json, else sample)
    async function getPassage(version, book, chapter, v1, v2){
      const path = `bibles/${version}/${book}.json`;
      try {
        const r = await fetch(path);
        if(r.ok){
          const data = await r.json();
          const verses = data[String(chapter)] || [];
          if(!verses.length) throw new Error('No chapter');
          const s = v1 ? v1-1 : 0;
          const e = v2 ? v2-1 : verses.length-1;
          return verses.slice(s, e+1).map((t,i)=>({ n:(s+i+1), t }));
        }
      } catch {}
      // Fallback to sample
      const src = SAMPLE[version]?.[book]?.[String(chapter)] || [];
      const s = v1 ? v1-1 : 0;
      const e = v2 ? v2-1 : src.length-1;
      const arr = src.slice(s, e+1).map((t,i)=>({ n:(s+i+1), t }));
      if(arr.length===0) return [{n:0, t:`[${version}] ${book} ${chapter}:${v1||1}${v2?'-'+v2:''} not available in demo. Add /bibles/${version}/${book}.json to your repo.`}];
      return arr;
    }

    function versesToHTML(vs){
      return vs.map(v=>`<span class="text-slate-500 text-xs align-top mr-1">${v.n}</span>${escapeHtml(v.t)}`).join(' ');
    }

    // Study rendering
    async function renderStudy(){
      const ref = thisWeekRef();
      const parsed = parseRef(ref);
      document.getElementById('studyRef').innerText = ref + ' (' + state.primary + (state.secondary!=='none'? ' + ' + state.secondary : '') + ')';

      const primary = await getPassage(state.primary, parsed.book, parsed.chapter, parsed.v1, parsed.v2);
      document.getElementById('studyPassageHeading').innerText = `${parsed.book} ${parsed.chapter}:${parsed.v1}${parsed.v2?'–'+parsed.v2:''} — ${state.primary}`;
      document.getElementById('studyPassageText').innerHTML = versesToHTML(primary);

      if(state.secondary!=="none"){
        const sec = await getPassage(state.secondary, parsed.book, parsed.chapter, parsed.v1, parsed.v2);
        document.getElementById('compareBox').classList.remove('hidden');
        document.getElementById('compareText').innerHTML = `<div class="text-slate-500 text-xs">${state.secondary}</div>` + versesToHTML(sec);
      } else {
        document.getElementById('compareBox').classList.add('hidden');
        document.getElementById('compareText').innerHTML = '';
      }

      // Day lens content
      const dow = ((new Date().getDay()+6)%7)+1; // Mon=1..Sun=7
      renderLens(dow, parsed);

      // Load notes
      const notesKey = `notes:${ref}`;
      document.getElementById('studyNotes').value = LS.get(notesKey, '');
      document.getElementById('saveNotesBtn').onclick = () => {
        LS.set(notesKey, document.getElementById('studyNotes').value);
        toast('Notes saved');
      };

      document.getElementById('openInBibleBtn').onclick = () => {
        nav('bible');
        openRef(parsed);
      };
    }

    function renderLens(day, parsed){
      const el = document.getElementById('lensContent');
      const refStr = `${parsed.book} ${parsed.chapter}:${parsed.v1}${parsed.v2?'–'+parsed.v2:''}`;
      const lenses = {
        1: {
          title: 'Context & Big Picture',
          body: `Read ${refStr} in light of its paragraph and book. Who is speaking? To whom? Where does this fit in the storyline of Scripture? Summarise the flow before and after the verse in 2–3 bullet points.`
        },
        2: {
          title: 'Translation Compare & Wording',
          body: `Compare ${state.primary} with your secondary translation. Note differences in key verbs and nouns. Which wording clarifies the meaning? Why might translators differ here?`
        },
        3: {
          title: 'Word Study & Key Terms',
          body: `Identify 1–2 key words in ${refStr}. Define them using a reliable lexicon (e.g., for John 3:16, “only begotten/one and only,” “believe,” “eternal life”). Paraphrase the verse in your own words.`
        },
        4: {
          title: 'Theologians & Traditions',
          body: `How have major voices read this text? For example: Augustine (love and Trinity), Athanasius (Incarnation), Aquinas (virtues and charity), Luther (faith and grace), Calvin (union with Christ), Wesley (holiness). Note agreements and tensions, and what each emphasises.`
        },
        5: {
          title: 'Cross‑References',
          body: `Find 3–5 cross‑references that illuminate ${refStr}. Trace a theme across Scripture (promise→fulfilment, law→gospel, creation→new creation).`
        },
        6: {
          title: 'Meditation & Prayer',
          body: `Slowly re‑read ${refStr}. What does this reveal about God’s character? Turn phrases into prayer. Sit in silence for one minute, then write a one‑sentence “I will…” response.`
        },
        7: {
          title: 'Application & Memorisation',
          body: `Commit ${refStr} to memory. Write a practical step for this week (specific, small, time‑bound). Re‑state the verse as a personal promise or command.`
        }
      };
      const lens = lenses[day];
      el.innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-slate-600">Day ${day} lens</div>
            <h3 class="font-semibold text-lg">${lens.title}</h3>
          </div>
          <div class="text-sm text-slate-500">${new Date().toLocaleDateString()}</div>
        </div>
        <p class="mt-2">${lens.body}</p>
        <div class="mt-3">
          <label class="text-sm font-semibold">Quick prompts</label>
          <ul class="list-disc ml-5 text-sm text-slate-700">
            ${quickPrompts(day, parsed).map(x=>`<li>${x}</li>`).join('')}
          </ul>
        </div>
      `;

      for(const b of document.querySelectorAll('.lensBtn')){
        b.classList.toggle('bg-indigo-600', Number(b.dataset.day)===day);
        b.classList.toggle('text-white', Number(b.dataset.day)===day);
        b.onclick = ()=> renderLens(Number(b.dataset.day), parsed);
      }
    }

    function quickPrompts(day, parsed){
      const book = parsed.book;
      if(day===1) return [
        `Who are the main actors in ${book}?`,
        `What is the immediate question or problem?`,
        `How does this verse move the argument forward?`
      ];
      if(day===2) return [
        `Which words differ between versions?`,
        `What nuance changes if you swap those words?`,
        `Draft a one‑sentence meaning that respects both.`
      ];
      if(day===3) return [
        `Circle the key verb(s) and noun(s).`,
        `Check a lexicon (original languages or a good dictionary).`,
        `Write a paraphrase using today’s terms.`
      ];
      if(day===4) return [
        `What attribute of God is emphasised?`,
        `How do grace and obedience relate here?`,
        `Where do traditions agree; where do they warn?`
      ];
      if(day===5) return [
        `Find earlier echoes in the OT.`,
        `Find fulfilment in Jesus/the Church.`,
        `Find future hope in Revelation.`
      ];
      if(day===6) return [
        `Turn the verse into a prayer.`,
        `Sit in silence (1 min).`,
        `Write a single “I will…” line.`
      ];
      return [
        `Test your memory: speak it aloud.`,
        `Write one concrete next step for this week.`,
        `Share with a friend for encouragement.`
      ];
    }

    // Bible view
    function showBooks(which){
      const cont = document.getElementById('books');
      cont.innerHTML = '';
      for(const b of BOOKS[which]){
        const btn = document.createElement('button');
        btn.className = 'px-3 py-2 rounded-lg bg-slate-200';
        btn.textContent = b;
        btn.onclick = ()=> showChapters(b);
        cont.appendChild(btn);
      }
      document.getElementById('chapters').innerHTML = '';
      document.getElementById('verses').innerHTML = '';
    }

    async function showChapters(book){
      const chaptersEl = document.getElementById('chapters');
      chaptersEl.innerHTML = '';
      // Try to guess chapter count from sample or fallback to 50
      const chs = SAMPLE[state.primary]?.[book] ? Object.keys(SAMPLE[state.primary][book]).map(Number) : Array.from({length:50}, (_,i)=>i+1);
      const maxCh = Math.max(...chs);
      for(let i=1;i<=Math.min(maxCh,150);i++){
        const b = document.createElement('button');
        b.className = 'px-2 py-1 rounded bg-slate-100';
        b.textContent = i;
        b.onclick = ()=> showChapter(book, i);
        chaptersEl.appendChild(b);
      }
      document.getElementById('verses').innerHTML = '';
    }

    async function showChapter(book, chapter){
      const versesEl = document.getElementById('verses');
      versesEl.innerHTML = '<div class="text-sm text-slate-500">Loading…</div>';
      const vs = await getPassage(state.primary, book, chapter, null, null);
      const secVs = state.secondary!=='none' ? await getPassage(state.secondary, book, chapter, null, null) : null;
      const pairs = vs.map((v,i)=>({ n:v.n, a:v.t, b: secVs? (secVs[i]?.t||'') : null }));
      versesEl.innerHTML = pairs.map(p=>`
        <div class="p-3 rounded-xl bg-slate-50">
          <div class="text-slate-500 text-xs">${book} ${chapter}:${p.n}</div>
          <div class="mt-1">${escapeHtml(p.a)}</div>
          ${p.b!==null ? `<div class="mt-2 text-sm border-t pt-2"><span class="text-slate-500 text-xs">${state.secondary}</span><br>${escapeHtml(p.b)}</div>`:''}
        </div>
      `).join('');
    }

    function openRef(parsed){
      // Open navigator to book/chapter and scroll to first verse
      const which = BOOKS.NT.includes(parsed.book) ? 'NT' : 'OT';
      showBooks(which);
      showChapters(parsed.book);
      showChapter(parsed.book, Number(parsed.chapter));
      setTimeout(()=> {
        const target = document.querySelector(`#verses .p-3`);
        if(target) target.scrollIntoView({behavior:'smooth', block:'start'});
      }, 300);
    }

    // Simple export/import for notes
    document.getElementById('exportBtn').onclick = () => {
      const data = {};
      for(let i=0; i<localStorage.length; i++){
        const k = localStorage.key(i);
        if(k.startsWith('notes:') || k==='state') data[k] = localStorage.getItem(k);
      }
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'bible-study-notes.json';
      a.click();
    };
    document.getElementById('importInput').onchange = async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const text = await file.text();
      try {
        const obj = JSON.parse(text);
        for(const [k,v] of Object.entries(obj)){
          localStorage.setItem(k, v);
        }
        state = LS.get('state', state);
        primaryVersion.value = state.primary;
        secondaryVersion.value = state.secondary;
        toast('Imported');
        renderHome(); renderStudy();
      } catch {
        toast('Import failed');
      }
    };

    // Today button: jump to study
    document.getElementById('todayBtn').onclick = ()=> nav('study');

    // Random blessing line in drawer
    const blessings = [
      'Psalm 119:105', 'Numbers 6:24-26', 'Philippians 4:7', 'Romans 15:13', 'Jude 24-25'
    ];
    function setBlessing(){
      const r = blessings[Math.floor(Math.random()*blessings.length)];
      const p = parseRef(r);
      getPassage('KJV', p.book, p.chapter, p.v1, p.v2).then(vs => {
        document.getElementById('randomBlessing').innerHTML = `“${escapeHtml(vs.map(x=>x.t).join(' '))}” — ${r}`;
      });
    }

    // Helpers
    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      t.className = 'fixed bottom-16 left-1/2 -translate-x-1/2 px-3 py-2 rounded-lg bg-slate-900 text-white shadow';
      document.body.appendChild(t);
      setTimeout(()=> t.remove(), 1800);
    }
    function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])) }

    // Initial render
    renderHome();
    renderStudy();
    setBlessing();

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('Service Worker registered successfully:', registration.scope);
          })
          .catch((error) => {
            console.error('Service Worker registration failed:', error);
          });
      });
    }
  </script>
</body>
</html>
